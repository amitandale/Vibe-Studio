name: Deploy to VPS
on:
  workflow_dispatch:
concurrency:
  group: deploy-vps
  cancel-in-progress: false
jobs:
  deploy:
    name: Build and Deploy
    runs-on: self-hosted
    environment:
      name: production
    steps:
      - name: Set deployment variables
        id: vars
        run: |
          BRANCH="${{ github.ref_name }}"
          if [[ "$BRANCH" == "main" ]]; then
            echo "port=3000" >> $GITHUB_OUTPUT
            echo "deploy_dir=${{ github.workspace }}/vibe-main" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" == "work" ]]; then
            echo "port=3001" >> $GITHUB_OUTPUT
            echo "deploy_dir=${{ github.workspace }}/vibe-work" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" == codex/* ]]; then
            echo "port=3002" >> $GITHUB_OUTPUT
            echo "deploy_dir=${{ github.workspace }}/vibe-codex" >> $GITHUB_OUTPUT
          else
            echo "port=3000" >> $GITHUB_OUTPUT
            echo "deploy_dir=${{ github.workspace }}/vibe-main" >> $GITHUB_OUTPUT
          fi

      - name: Create deployment directory
        run: mkdir -p ${{ steps.vars.outputs.deploy_dir }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: ${{ steps.vars.outputs.deploy_dir }}

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Enable Corepack
        run: corepack enable

      - name: Activate pnpm from packageManager field
        working-directory: ${{ steps.vars.outputs.deploy_dir }}
        run: corepack prepare $(node -p "require('./package.json').packageManager") --activate

      - name: Add pnpm to PATH
        run: echo "$(corepack --help &>/dev/null && dirname $(which corepack))" >> $GITHUB_PATH

      - name: Verify pnpm installation
        run: |
          which pnpm
          pnpm --version

      - name: Install dependencies
        working-directory: ${{ steps.vars.outputs.deploy_dir }}
        run: pnpm install --frozen-lockfile

      - name: Build Next.js application
        working-directory: ${{ steps.vars.outputs.deploy_dir }}
        run: pnpm run build

      # - name: Prune to production dependencies
      #   run: pnpm prune --prod

      - name: Open port for application access
        run: sudo ufw allow ${{ steps.vars.outputs.port }}/tcp

      - name: Stop all PM2 processes on this port
        run: |
          PORT=${{ steps.vars.outputs.port }}
          echo "Cleaning up all PM2 processes using port $PORT..."
          
          # Get all PM2 processes and check which ones are using this port
          pm2 jlist | jq -r '.[] | select(.pm2_env.env.PORT == "'$PORT'") | .name' 2>/dev/null | while read proc_name; do
            if [ -n "$proc_name" ]; then
              echo "Deleting PM2 process using port $PORT: $proc_name"
              pm2 delete "$proc_name" || true
            fi
          done
          
          # Also try to delete by current branch name as fallback
          pm2 delete ${{ github.ref_name }} || true

      - name: Kill orphaned processes on port
        run: |
          PORT=${{ steps.vars.outputs.port }}
          PIDS=$(sudo lsof -t -i :$PORT || true)
          if [ -n "$PIDS" ]; then
            echo "Killing orphaned processes on port $PORT (PIDs: $PIDS)"
            sudo kill -9 $PIDS
          else
            echo "No processes found on port $PORT - port is clear"
          fi

      - name: Start application with PM2
        working-directory: ${{ steps.vars.outputs.deploy_dir }}
        run: |
          PORT=${{ steps.vars.outputs.port }} pm2 start pnpm --name ${{ github.ref_name }} -- run start
          pm2 save

      - name: Show deployment summary
        run: |
          PUBLIC_IP=$(curl -4 ifconfig.me)
          echo "âœ… Deployment completed successfully!"
          echo "ğŸ“¦ Branch: ${{ github.ref_name }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ğŸ”— App Link: http://$PUBLIC_IP:${{ steps.vars.outputs.port }}"
          echo "ğŸ“ Deploy Dir: ${{ steps.vars.outputs.deploy_dir }}"
