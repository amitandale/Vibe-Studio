name: Deploy to VPS
on:
  workflow_dispatch:
    inputs:
      service_restart_command:
        description: "Optional command to restart the application service (e.g. 'sudo systemctl restart vibe-studio'). Leave blank to skip."
        required: false
        default: ""
concurrency:
  group: deploy-vps
  cancel-in-progress: false
jobs:
  deploy:
    name: Build and Deploy
    runs-on: self-hosted
    environment:
      name: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Enable Corepack
        run: corepack enable
      - name: Activate pnpm from packageManager field
        run: corepack prepare $(node -p "require('./package.json').packageManager") --activate
      - name: Add pnpm to PATH
        run: echo "$(corepack --help &>/dev/null && dirname $(which corepack))" >> $GITHUB_PATH
      - name: Verify pnpm installation
        run: |
          which pnpm
          pnpm --version
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build Next.js application
        run: pnpm run build
      - name: Prune to production dependencies
        run: pnpm prune --prod
      - name: Restart (or start) branch app with PM2
        run: |
          pm2 delete ${{ github.ref_name }} || true
          pm2 start pnpm --name ${{ github.ref_name }} -- run start
          pm2 save
      - name: Show deployment summary
        run: |
          echo "✅ Deployment completed successfully!"
          echo "📦 Branch: ${{ github.ref_name }}"
          echo "📝 Commit: ${{ github.sha }}"
          echo "👤 Triggered by: ${{ github.actor }}"
